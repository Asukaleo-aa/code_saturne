%-------------------------------------------------------------------------------

% This file is part of Code_Saturne, a general-purpose CFD tool.
%
% Copyright (C) 1998-2013 EDF S.A.
%
% This program is free software; you can redistribute it and/or modify it under
% the terms of the GNU General Public License as published by the Free Software
% Foundation; either version 2 of the License, or (at your option) any later
% version.
%
% This program is distributed in the hope that it will be useful, but WITHOUT
% ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
% FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
% details.
%
% You should have received a copy of the GNU General Public License along with
% this program; if not, write to the Free Software Foundation, Inc., 51 Franklin
% Street, Fifth Floor, Boston, MA 02110-1301, USA.

%-------------------------------------------------------------------------------

%-------------------------------------------------------------------------------
\section{Time discretisation of a transport equation}

At first, the physical properties of the flow are computed (density,
viscosity, specific heat \emph{etc.}): indeed, they may depend upon the variables
(such as the temperature for example).

The time scheme is a $\theta$-scheme:
\begin{equation}
\left\{%
\begin{array}{ll}
\theta = 1 & \text{for an implicit first order Euler scheme} \\
\theta = \frac{1}{2} & \text{for second order Crank-Nicolson scheme}%
\end{array}
\right.
\end{equation}

For the second order scheme, the time step is assumed to be constant.

If required, the equations for the turbulent variables are solved (turbulent
kinetic energy and dissipation or Reynolds stresses and dissipation), using
a $\theta$-scheme again. For the $k-\varepsilon$ model, an additional step
is carried out to couple the source terms. For the Reynolds stress model,
the variables (turbulent stresses and dissipation) are solved sequentially,
without coupling.

Next, the equations for the ``scalars'' (enthalpy, temperature, tracers,
concentrations, mass fractions...) are solved, also with a $\theta$-scheme.

Finally, all the variables are updated and another time step may start.

The general equation for advection (valid for the velocity components, the
turbulent variables and the scalars) is re-written as follows in a condensed
form; the mass equation ($\frac{\partial \rho } {\partial t}+ \dive(\rho
\vect{u}) = \Gamma$ see Equation (\ref{eq:mass})) has been used to split the time derivative:
%
\begin{equation}\label{eq:transport_eq_scalar}%Base_Introd_simple}
\rho \frac {\partial f}{\partial t} + \dive  \left(f \rho\,\vect{u}) \right) - %
\dive \left(K \grad f \right) = S_{i}\left(\Phi, \, \varphi\right)\,f + S_{e}\left(\Phi,\varphi \right) 
+ \dive  \left(\rho\,\vect{u} \right)\,f
\end{equation}
In this equation:

\begin{tabular}{ll}
$\Phi$ & : represents the physical properties $(\rho,K,\mu_{t},...)$ \\
$\varphi$ & : represents the variables of the problem $(\vect{u}%
,k,\epsilon,...)$ \\
$S_{i}\left(\Phi, \, \varphi \right)\,f$ & : represents the linear part of the source terms
\\
$S_{e} \left(\Phi, \, \varphi \right)$ & : includes all other source terms \\
$\dive \left(\rho\,\vect{u}\right)\,f$ & : is the term associated with ``mass
accumulation''%
\end{tabular}

The time at which the different quantities are evaluated is indicated below:
%
\begin{description}
\item[$\Phi$:] the time considered is defined by the time scheme applied
to the physical properties.
\item[$\rho\,\vect{u}$:] the time considered is defined by the
time scheme applied to the mass flux.
\item[$S_{e}\left(\Phi, \, \varphi \right)$:] the time considered is defined by the time
scheme applied to the explicit source terms.
\end{description}

If $\theta=1/2$, or if an extrapolation is used, the time step $\Delta t$ is
constant in time and uniform in space.

\subsection{Physical properties}

The physical properties of the flow (density, viscosity, specific heat...)
are:

\begin{itemize}
\item either explicit, defined at the time step $n$.
\item or extrapolated at $n+\theta _{\Phi }$ using the Adam-Bashforth
time scheme (in this case, the time step is assumed to be constant).
\end{itemize}

Under a more general form, this reads:
\begin{equation}
\Phi \equiv \Phi^{n+\theta_{\Phi}}=(1+\theta_{\Phi})\,\Phi^{n}-
\theta_{\Phi}\,\Phi^{n-1}
\end{equation}

\begin{equation}
\left\{%
\begin{array}{ll}
\theta_{\Phi} = 0 & \text{standard explicit formulation} \\
\theta_{\Phi} = 1/2 & \text{second order extrapolation at } n+1/2 \\
\theta_{\Phi} = 1 & \text{first order extrapolation at } n+1%
\end{array}
\right.
\end{equation}

\subsection{Mass flux}

For the mass flux, three time schemes are available. The mass flux may be:
%
\begin{itemize}
\item explicit, taken at time step $n$ for the momentum equations and
updated with its value at time step $n+1$ for the equations for turbulence
and scalars (standard scheme).

\item explicit, taken at time step $n$ for the momentum equations and
also for the equations for turbulence and scalars.

\item taken at $n+\theta_{F}$ (second order if $\theta_{F}=1/2$). To
solve the momentum equations, $\left(\rho\,\vect{u}\right)^{n-2+\theta_{F}}$ and $%
\left(\rho\,\vect{u}\right)^{n-1+\theta_{F}}$ are known. Hence, the value at $%
n+\theta_{F}$ is obtained as a result of the following extrapolation:
\begin{equation}
\left(\rho\,\vect{u}\right)^{n+\theta_{F}}= 2\,\,\left(\rho\,\vect{u}%
\right)^{n-1+\theta_{F}} -\,\,\left(\rho\,\vect{u}\right)^{n-2+\theta_{F}}
\end{equation}
At the end of this phase (after the pressure correction step), $\left(\rho\,%
\vect{u}\right)^{n+1}$ is known and the following interpolation is used to
determine the mass flux at $n+\theta_{F}$ that will be adopted for the
equations for turbulence and scalars:
\begin{equation}
\left(\rho\,\vect{u}\right)^{n+\theta_{F}}= \frac{1}{2-\theta_{F}}\,\left(\rho\,%
\vect{u}\right)^{n+1} +\frac{1-\theta_{F}}{2-\theta_{F}}\,\left(\rho\,\vect{u}%
\right)^{n-1+\theta_{F}}
\end{equation}
\end{itemize}

\subsection{Source terms}

As for the physical properties, the \textbf{explicit} source terms are:

\begin{itemize}
\item explicit:
\begin{equation}
\left[ S_{e} \left(\Phi , \, \varphi \right) \right]^{n}=S_{e}\left(\Phi ^{n+\theta_{\Phi }}, \, \varphi
^{n} \right)
\end{equation}

\item extrapolated at $n+\theta _{S}$ using the Adams-Bashforth scheme:
\begin{equation}
\left[ S_{e} \left(\Phi , \, \varphi \right) \right]^{n+\theta _{S}}=\left(1+\theta _{S}\right)\,
S_{e}\left(\Phi^{n}, \, \varphi^{n}\right)-\theta _{S}\,S_{e} \left(\Phi ^{n-1} , \,\varphi ^{n-1}\right)
\end{equation}
\end{itemize}

By default, to be consistent and preserve the order of convergence in time,
the implicit source terms are discretized with the same scheme as that used
for convection-diffusion of the unknown considered, \emph{i.e.} taken at $%
n+\theta $:
\begin{equation}
\lbrack S_{i}(\Phi ,\varphi )\,f]^{n+\theta }=S_{i}(\Phi ^{n+\theta _{\Phi
}},\varphi ^{n})\,[\theta \,f^{n+1}+(1-\theta )\,f^{n}]
\end{equation}

\begin{remark}
The \textbf{implicit} source terms taken also at $n+\theta $ for $\theta
_{S}\neq 0$, while for $\theta _{S}=0$, the implicit source terms are taken
at $n+1$ , this to enhance stability.
\end{remark}

\subsection{General time discretized form}

For the sake of clarity, it is assumed hereafter that, unless otherwise
explicitly stated, the mass flux is taken at $n+\theta_F$ and the physical
properties are taken at $n+\theta_\Phi$, with $\theta_F$ and $\theta_\Phi$
dependant upon the specific schemes selected for the mass flux and the
physical properties respectively.

Under a general form, the discrete counterpart of Equation~(\ref{eq:transport_eq_scalar}) at
$n+\theta$ reads:
\begin{equation}
\begin{array}{rcl}
\displaystyle \frac{\rho}{\Delta t} \left(f^{n+1}-f^{n}\right)+ \dive \left(f^{n+\theta}(\rho\,%
\vect{u}) - K \grad f^{n+\theta} \right) &=&
\left[S_{i}(\Phi, \, \varphi)\,f\right]^{n+\theta} + \left[S_{e}(\Phi, \, \varphi)
\right]^{n+\theta_{S}} \\
&+& \dive \left(\rho\,\vect{u} \right)\,f^{n+\theta}%
\end{array}%
\end{equation}

Using the standard $\theta$-scheme $f^{n+\theta}=\theta\,f^{n+1}+\left(1-\theta \right)%
\,f^{n}$, the equation reads:
\begin{equation}
\begin{array}{rcl}
\displaystyle \frac{\rho}{\Delta t} \left(f^{n+1}-f^{n} \right)
+ \theta\,\dive \left( f^{n+1}(\rho\,%
\vect{u}) - K \grad f^{n+1} \right) &=& 
- \left(1-\theta\right)\,\dive \left(f^{n} (\rho\,\vect{u}) -K %
\grad \,f^{n}\right)  \\
&+& S_{i}\left(\Phi , \,\varphi^n\right)\left[\theta\,f^{n+1}+ \left(1-\theta \right)\,f^{n}\right] 
+ \left[ S_{e}(\Phi, \, \varphi)\right]^{n+\theta_{S}} \\
&+& \dive \left(\rho\,\vect{u} \right)
\,\left(\theta\,f^{n+1}+\left(1-\theta\right)\,f^{n}\right)%
\end{array}%
\end{equation}

For numerical reasons, the system is solved in an iterative and incremental
manner, with the help of the series $\delta f^{n+1}_{k+1}=f^{n+1}_{k+1}-f^{n+1}_{k}
$ (with, by definition, $f^{n+1}_0=f^{n}$). In particular, this method
allows to treat implicitly a portion of the advection-diffusion terms
associated correction terms for non orthogonal meshes. Hence, the system
actually solved reads:
\begin{equation}
\begin{array}{r c l}
\begin{array}{r}
\displaystyle\overbrace{
\left[ \frac{\rho }{\Delta t}-\theta \,S_{i} \left(\Phi
, \, \varphi ^{n}\right)-\theta \,\dive \left(\rho \,\vect{u} \right)\,\right] 
}^{%
\displaystyle \var{ROVSDT}} 
\,\delta f^{n+1}_{k+1}\\
+\theta \,\dive \left( \delta f^{n+1}_{k+1} \rho \,\vect{u} -
 K\grad \delta f^{n+1}_{k+1} \right)
\end{array}
&=& 
\left.
\begin{array}{l}
-\theta \,\dive \left( f^{n+1}_{k} \left(\rho \,\vect{u}\right)- K\grad f^{n+1}_{k}\right) \\
-(1-\theta )\,\dive \left( f^{n} \left(\rho \,\vect{u}\right) - K \grad f^{n} \right) \\
\displaystyle-\frac{\rho }{\Delta t} \left(f^{n+1}_{k}-f^{n} \right)
+S_{i}\left(\Phi , \, \varphi^{n}\right)
\left[ \theta \,f^{n+1}_{k}+ \left(1-\theta \right)\,f^{n}\right]  \\
+\dive \left(\rho \,\vect{u}\right)\,\left(\theta \,f^{n+1}_{k}+\left(1-\theta \right)\,f^{n}\right)+%
\left[ S_{e}\left(\Phi , \, \varphi \right)\right] ^{n+\theta _{S}}%
\end{array}%
\right\}\var{SMBRS}
\end{array}%
\end{equation}

%TODO suppress ROVSDT and SMBR! suppress the name of the routines.
Whatever the equation considered (momentum equation, equations for
turbulence or scalars,...) the system representation is always the same: a
right-hand side (stored in the vector-array \var{SMBRS}) and a vector-array %
\var{ROVSDT} for the part linear with respect to $\delta f^{n+1}_{k+1}$.%

\begin{itemize}
\item The vector-array \var{ROVSDT} is computed by the subroutine %
\fort{covofi} (see \S \ref{ap:covofi}) for the scalars, by \fort{preduv} (see \S \ref{ap:preduv}) for the velocity and by %
\fort{turbke} (see \S \ref{ap:turbke}) or \fort{turrij} (see \S \ref{ap:turrij}) for the turbulence.

\item The vector-array \var{SMBRS} is not computed at one go, but in two
successive steps.

The first part is calculated by the subroutines \fort{covofi} (see \S \ref{ap:covofi}), \fort{preduv}%
(see \S \ref{ap:preduv}), \fort{turbke} (see \S \ref{ap:turbke}) and \fort{turrij} (see \S \ref{ap:turrij}) (respectively for the scalars, the
velocity and the turbulence). At that point, the vector \var{SMBRS} is
defined as follows:
\begin{equation}
\var{SMBRS}=S_{i} \left(\Phi , \, \varphi ^{n}\right)\,f^{n}
+\dive \left(\rho \,\vect{u} \right)\,f^{n}
+\left[ S_{e} \left(\Phi , \, \varphi \right)\right] ^{n+\theta _{S}}%
\end{equation}%
then, the calculation of \var{SMBRS} is complemented at each sub-iteration
during the resolution of the equation by the subroutine \fort{codits} (see \S \ref{ap:codits})as
follows:
\begin{equation}
\begin{array}{r c l}
\var{SMBRS} & = & \var{SMBRS}-\var{ROVSDT}\,\left(f^{n+1}_{k}-\,f^{n} \right) \\
&-&\theta \,\dive \left( f^{n+1}_{k} \left(\rho \,\vect{u}\right)
- K\grad f^{n+1}_{k}\right) \\
&-& \left(1-\theta \right)\,\dive \left( f^{n} \left(\rho \,\vect{u}\right) - K%
\grad f^{n} \right)%
\end{array}%
\end{equation}

More theoretical details of such an iterative process are given in \S \ref{sec:algebrea_iterative_process}.

\end{itemize}

%-------------------------------------------------------------------------------
\section{Pressure-based velocity-pressure solver}
A fractional step scheme is used to solve the mass and momentum equations
(see Chorin \cite{Chorin:????}). The first step (predictor step) provides predicted velocity
components: they are determined sequentially and without coupling between
each other. The mass equation is taken into account during the second step
(corrector step): a pressure Poisson equation is solved and the mass fluxes
at the cell faces are updated.

\subsection{Segregated solver}
Work in progress.
\subsection{Coupled solver}
Work in progress.
\section{steady algorithm}
Work in progress.
\section{Unsteady algorithm}
Work in progress.

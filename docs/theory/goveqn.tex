%-------------------------------------------------------------------------------

% This file is part of Code_Saturne, a general-purpose CFD tool.
%
% Copyright (C) 1998-2013 EDF S.A.
%
% This program is free software; you can redistribute it and/or modify it under
% the terms of the GNU General Public License as published by the Free Software
% Foundation; either version 2 of the License, or (at your option) any later
% version.
%
% This program is distributed in the hope that it will be useful, but WITHOUT
% ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
% FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
% details.
%
% You should have received a copy of the GNU General Public License along with
% this program; if not, write to the Free Software Foundation, Inc., 51 Franklin
% Street, Fifth Floor, Boston, MA 02110-1301, USA.

%-------------------------------------------------------------------------------

%-------------------------------------------------------------------------------
\section{Continuous mass and momentum equations}
%-------------------------------------------------------------------------------

This section presents the continuous equations. It is no substitutes for the
specific sub-sections of this documentation: the purpose here is mainly to
provide an overview before more detailed reading.

In the following, $\rho $ stands for the density, $\vect{u}$ for the
velocity field. A mass source term, $\Gamma $ , may present, but in most
cases the right-hand side of the Mass equation is $\Gamma =0$. 
\nomenclature[grho]{$\rho$}{density field \nomunit{$kg.m^{-3}$}}
\nomenclature[rut1]{$\vect{u}$}{velocity field \nomunit{$m.s^{-1}$}}
\nomenclature[ggamma ]{$\Gamma$}{mass source term}
The continuity equation (also called mass equation) is displayed in (\ref{eq:mass}).

\begin{equation}\label{eq:mass}
\dfrac{\partial \rho}{\partial t} + \dive(\rho \vect{u})=\Gamma.
\end{equation}

In fact, to compute a given unknown $\phi$ (and in particular for the
velocity prediction),
\nomenclature[gphi]{$\phi$}{scalar unknown field}
 the equation 
$\displaystyle \frac{\partial \rho}{\partial t} + \dive(\rho \vect{u}) = \Gamma$ 
is used to re-write the term 
$\displaystyle \frac{\partial \rho\,\phi}{\partial t}$ as follows:
\begin{equation*}
\dfrac{\partial \rho\,\phi}{\partial t} = \rho \dfrac{\partial  \phi}{\partial t} - \phi\,\dive(\rho \vect{u})
+ \Gamma\,\phi.
\end{equation*}
The possible variations in time of the density are however
not taken into account in the pressure correction step.

The momentum equation is:
\begin{equation}\label{eq:momentum}
\dfrac{\partial }{\partial t}(\rho \vect{u})
+\divv \left( \vect{u}\otimes \rho \vect{u} \right)
=\divv \left( \tens{\sigma} \right) +\vect{ST}_{\vect{u}}-\tens{K}\,\vect{u},
\end{equation}
where $\vect{ST}_{\vect{u}}$ and $\tens{K}\,\vect{u}$ stand for explicit and implicit additional 
momentum Source Terms
\nomenclature[rstut1]{$\vect{ST}_{\vect{u}}$}{explicit additional momemtum Source Termes \nomunit{$kg.m^{-2}.s^{-2}$}}
\nomenclature[rkt2]{$\tens{K}$}{tensor of the velocity head loss \nomunit{$kg.m^{-3}.s^{-1}$}}
\nomenclature[gsigmat2]{$\tens{\sigma}$}{total stress tensor \nomunit{$Pa$}}
 which may be prescribed by the user (head loss, $\Gamma \vect{u}^{i}$ 
contribution associated with a user-prescribed mass source term...).

$\tens{K}$ is a symetric positive tensor, by definition. 

\begin{itemize}
 \item For laminar flow, $\tens{\sigma}$ is the stress tensor:
\begin{equation}
\tens{\sigma}=\tens{\tau}-p\tens{Id}
\end{equation}%
where $\tens{\tau}$ is the viscous stress tensor,
\nomenclature[rp ]{$p$}{pressure field \nomunit{$Pa$}}
\nomenclature[gtaut2]{$\tens{\tau}$}{viscous stress tensor, which is the deviatoric part of the stress tensor \nomunit{$Pa$}}
 defined for a Newtonian fluid from $\mu =\mu_l $ (dynamic molecular viscosity) 
\nomenclature[gmu]{$\mu$}{dynamic viscosity \nomunit{$kg.m^{-1}.s^{-1}$}}
\nomenclature[gmul]{$\mu_l$}{dynamic molecular viscosity \nomunit{$kg.m^{-1}.s^{-1}$}}
and $\tens{S}$ (strain rate tensor) as:
\nomenclature[rst2]{$\tens{S}$}{strain rate tensor \nomunit{$s^{-1}$}}
\begin{equation}\label{eq:base_introd_tau}%Base_Introd_tau_eq}
\tens{\tau}=2\,\mu \ \deviator{\tens{S}} = 2\,\mu \ \tens{S}-\frac{2}{3}\mu \ \trace{\tens{S}}\ \tens{Id},
\end{equation}
%
\nomenclature[odeviator]{$\deviator{ \left(\tens{.} \right)}$}{deviatoric part of a tensor}
\nomenclature[otrace]{$\trace{ \left(\tens{.}\right)}$}{trace of a tensor}
%
with
\begin{equation}\label{eq:base_introd_strainrate}%Base_Introd_tau_eq}
 \tens{S}=\frac{1}{2} \left( \ggrad\vect{u}+\,
\transpose{\ggrad\vect{u}} \right).
\end{equation}


\item For turbulent flow, $\displaystyle \tens{\sigma}$ also accounts
for the turbulent Reynolds stress tensor (correlations of the velocity
fluctuations arising from the non linear convective term). The modelling of
the latter depends upon the turbulence model adopted:

\begin{itemize}
\item with an eddy-viscosity model (\emph{EVM}) such as the $%
k-\varepsilon $ model, the closure requires a turbulent viscosity $\mu _{t}$%
. With formally the same definition for $\tens{\tau}$ as in Equation~(\ref{eq:base_introd_tau}),
 but with $\mu =\mu _{l}+\mu _{t}$, $\tens{\sigma}$ reads:
\begin{equation}
\tens{\sigma}=\tens{\tau}-(p+\frac{2}{3}\rho k)\tens{Id}
\end{equation}

\item with the \emph{LES} approach, the definition for $\tens{\sigma}$
remains the same as for the \emph{EVM}, above, but the turbulent viscosity $\mu
_{t} $ now accounts only for the sub-grid effects.

\item with a Differential Reynolds Stress Model (\emph{DRSM}), the
components of the Reynolds stress tensor $\tens{R}$ are solved as extra
variables during the simulation, and are readily available for the momentum
equation, so one obtains, with $\mu =\mu _{l}$ in the definition of $%
\tens{\tau}$ (Equation~(\ref{eq:base_introd_tau})):
\begin{equation}
\tens{\sigma}=\tens{\tau}-p\tens{Id}-\rho \tens{R}
\end{equation}

\end{itemize}
\end{itemize}

In the following, only three standard types of turbulence models are
described, as representatives of the types of equations that need to be
dicretised. 
% TODO A more detailed description of available turbulence models is
% described in section 
%TODO(?? Turbulence Models??)

%-------------------------------------------------------------------------------
\section{Turbulence modelling}
\subsection{Equations for the variables $k$ and $\varepsilon$
(standard $k-\varepsilon$ model)}

\begin{equation}
\left\{
\begin{array}{r c l}
\displaystyle\frac{\partial }{\partial t}(\rho k)+\dive\left[ \rho \vect{u}%
\,k- \left( \mu +\frac{\mu _{t}}{\sigma _{k}} \right)\grad{k}\right] 
&=&
\mathcal{P}+\mathcal{G}-\rho \varepsilon +\Gamma k^{i}+ST_{k}, \\
\displaystyle\frac{\partial }{\partial t}(\rho \varepsilon )+\dive\left[
\rho \vect{u}\,\varepsilon -(\mu +\frac{\mu _{t}}{\sigma _{\varepsilon }})%
\grad{\varepsilon}\right] &=&C_{\varepsilon _{1}}\frac{\varepsilon }{k}\left[
\mathcal{P}+(1-C_{\varepsilon _{3}})\mathcal{G}\right] -\rho C_{\varepsilon
_{2}}\frac{\varepsilon ^{2}}{k}+\Gamma \varepsilon ^{i}+ST_{\varepsilon },%
\end{array}%
\right.
\end{equation}
\nomenclature[rk]{$k$}{turbulent kinetic energy \nomunit{$m^{2}.s^{-2}$}}
\nomenclature[gepslion]{$ \varepsilon $}{turbulent kinetic energy dissipation \nomunit{$m^{2}.s^{-3}$}}
\nomenclature[rproduction]{$\mathcal{P}$}{turbulent kinetic energy production \nomunit{$kg.m^{-1}.s^{-3}$}}
where $\mathcal{P}$ is the production term created by mean shear:
%
\begin{equation}
\begin{array}{rcl}
\mathcal{P} & = & \displaystyle -\rho \tens{R} : \gradt \, \vect{u}
= -\left[-2 \mu_t \deviator{\tens{S}}%
+ \frac{2}{3}\rho k \tens{1}\right] : \tens{S}, \\
& = & \displaystyle \mu_t \left[ 2\left(\frac{\partial u}{\partial x}%
\right)^2+ 2\left(\frac{\partial v}{\partial y}\right)^2+ 2\left(\frac{%
\partial w}{\partial z}\right)^2+ \left(\frac{\partial u}{\partial y}+\frac{%
\partial v}{\partial x}\right)^2+ \left(\frac{\partial u}{\partial z}+\frac{%
\partial w}{\partial x}\right)^2+ \left(\frac{\partial v}{\partial z}+\frac{%
\partial w}{\partial y}\right)^2 \right] \\
&&-\frac{2}{3}\mu_t \left( \dive\vect{u} \right)^2-\frac{2}{3}
\rho k \dive \left( \vect{u} \right),
\end{array}
\end{equation}
\nomenclature[rbuoyancy]{$\mathcal{G}$}{turbulent kinetic energy buoyancy term \nomunit{$kg.m^{-1}.s^{-3}$}}
and
$\mathcal{G}$ is the production term created by gravity effects: 
\begin{equation}
\displaystyle \mathcal{G}= \frac{1}{\rho}\frac{\mu_t}{\sigma_t} \grad \rho \, . \, \vect{g}.
\end{equation}

The turbulent viscosity is: 
\begin{equation}
\displaystyle \mu_t=\rho C_\mu\frac{k^2}{%
\varepsilon}.
\end{equation}
\nomenclature[rstk]{$ST_{k}$}{additional turbulent kinetic energy source term \nomunit{$kg.m^{-1}.s^{-3}$}}
\nomenclature[rstepsilon]{$ST_{\varepsilon}$}{additional turbulent dissipation source term \nomunit{$kg.m^{-1}.s^{-4}$}}
$ST_{\varphi }$ ($\varphi =k$ or $\varepsilon $) stands for the additional
source terms prescribed by the user (in rare cases only).

The constants of the model are given in the Table (\ref{tab:k_epsilon_constants}):
\begin{table}[htp]
\centering
\begin{tabular}{p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}}
$C_\mu$ & $C_{\varepsilon_1}$ & $C_{\varepsilon_2}$ & $\sigma_k$ & $%
\sigma_\varepsilon$ \\ \hline
$0,09$ & $1,44$ & $1,92$ & $1$ & $1,3$ 
\end{tabular}%
\caption{Standard $k-\varepsilon$ model constants \cite{Launder:1972}.\label{tab:k_epsilon_constants}}
\end{table}
\nomenclature[rcmu]{$C_\mu$}{eddy viscosity constant}
\nomenclature[rcepsilon1]{$C_{\varepsilon_1}$}{constant of the standard $k-\varepsilon$ model}
\nomenclature[rcepsilon2]{$C_{\varepsilon_2}$}{constant of the standard $k-\varepsilon$ model}
\nomenclature[rcepsilon3]{$C_{\varepsilon_3}$}{constant of the standard $k-\varepsilon$ model depending on the buoyancy term}

$C_{\varepsilon_3}=0$ if $\mathcal{G}\geqslant0$ (unstable stratification)
and $C_{\varepsilon_3}=1$ if $\mathcal{G}\leqslant0$ (stable stratification).


%-------------------------------------------------------------------------------
\subsection{Equations for the Reynolds stress tensor components $R_{ij}$ 
and $\varepsilon$ (\emph{LRR} model)}
%
\nomenclature[rrt2]{$\tens{R}$}{Reynolds stress tensor \nomunit{$m^{2}.s^{-2}$}}
\nomenclature[rrij]{$R_{ij}$}{componant $ij$ of the Reynolds stress tensor \nomunit{$m^{2}.s^{-2}$}}

\begin{equation}
\left\{
\begin{array}{rcll}
\displaystyle\frac{\partial }{\partial t} \left(\rho R_{ij} \right)
+\dive \left(R_{ij} \, \rho \vect{u}-\mu \grad{R_{ij}} \right) 
& = & \mathcal{P}_{ij}+G_{ij}+\Phi _{ij}+\mathit{{d}_{ij}
-\rho \varepsilon _{ij}} & \displaystyle+\Gamma R_{ij}^{i}+ST_{R_{ij}},
\\
\displaystyle\frac{\partial }{\partial t}(\rho \varepsilon )
+\dive\left(\rho \vect{u}\,\varepsilon -\mu \grad{\varepsilon}\right) 
& = & \displaystyle \mathit{{d}+C_{\varepsilon _{1}}\frac{\varepsilon }{k}\left[ \mathcal{P}%
+G_{\varepsilon }\right] -\rho C_{\varepsilon _{2}}\frac{\varepsilon ^{2}}{k}} 
& \displaystyle+\Gamma \varepsilon ^{i}+ST_{\varepsilon },
\end{array}%
\right.
\end{equation}
\nomenclature[rproductiont2]{$\tens{\mathcal{P}}$}{turbulent production tensor \nomunit{$kg.m^{-1}.s^{-3}$}}
\nomenclature[rbuoyancyt2]{$\tens{\mathcal{G}}$}{turbulent buoyancy production tensor \nomunit{$kg.m^{-1}.s^{-3}$}}
where
$\tens{\mathcal{P}}$ stands for the turbulence production tensor associated
with mean flow strain-rate and $\tens{\mathcal{G}}$ is stands for the
production- tensor associated with buoyancy effects:
\begin{equation}
\begin{array}{r c l}
\displaystyle \tens{ \mathcal{P}} & = & \displaystyle-\rho \left[ \tens{R} \, . \, \gradt \, \vect{u} 
+ \gradt \, \vect{u}  \, . \, \tens{R}\right], \\
\tens{ \mathcal{G}} & = &
\displaystyle \frac{3}{2}\frac{C_{\mu }}{\sigma _{t}}
\frac{k}{\varepsilon }
\left[\vect{r} \otimes \vect{g} +\vect{g} \otimes \vect{r}  \right].
\end{array}
\end{equation}
where $ \vect{r} \equiv \tens{R} \, . \, \grad \, \rho$ and 
$G_{\varepsilon }= \Max \left(0, \, \frac{1}{2}\trace \tens{\mathcal{G}}\right)$.
\nomenclature[rrt1]{$\vect{r}$}{vector of the Reynolds stress tensor times the density gradient}
\nomenclature[rbuoyancyepsilon]{$G_{\varepsilon }$}{turbulent buoyancy term for dissipation}

With these definition the following relations hold:
\begin{equation}
\begin{array}{r c l}
\displaystyle k &=&\frac{1}{2} \trace{\tens{R}}, \\
\mathcal{P} &=&\frac{1}{2} \trace \left( \tens{\mathcal{P}} \right) ,
\end{array}
\end{equation}

$\tens{\Phi}$ is the term representing pressure-velocity correlations:
\nomenclature[gphit2]{$\tens{\Phi}$}{pressure-velocity correlation tensor \nomunit{$kg.s^{-3}$}}
\begin{equation}
\displaystyle \tens{\Phi} = \tens{\phi_{1}}+ \tens{\phi_{2}}+ \tens{\phi_{3}}+ \tens{\phi_{w}},
\end{equation}%
%
\begin{equation}
\begin{array}{r c l}
\tens{\phi_{1}} &=& \displaystyle -\rho \,C_{1}\frac{\varepsilon }{k}%
\deviator{\tens{R}}, \\
\tens{\phi_{2}} &=& -\rho \,C_{2} 
\deviator{\tens{\mathcal{P}}}, \\
\tens{\phi_{3}} &=& -C_{3} \deviator{ \tens{G} }.
\end{array}
\end{equation}

The term $\tens{\phi_{w}}$ is called ``wall echo term'' (by default, it is not
accounted for: see \fort{turrij} \ref{ap:turrij}).

The dissipation term, $\tens{\varepsilon}$ , is considered isotropic:
\nomenclature[gepsilont2]{$\tens{\varepsilon}$}{turbulent kinetic energy dissipation tensor \nomunit{$m^{2}.s^{-3}$}}
\begin{equation}
\displaystyle \tens{\varepsilon}=\frac{2}{3}\ \varepsilon \tens{1}.
\end{equation}

The turbulent diffusion terms are:
\begin{equation}
\begin{array}{r c l}
\tens{d} & = & C_{S} \displaystyle \divt \left( \rho \frac{k}{\varepsilon }%
\tens{R} \, . \, \gradtt \tens{R} \right), \\
d & = & C_{\varepsilon }\displaystyle \dive \left( \rho \frac{k}{\varepsilon} 
\tens{R} \, . \, \grad \varepsilon \right).
\end{array}
\end{equation}

In the rare event of masse sources, $\Gamma R_{ij}^{i}$ and $\Gamma
\varepsilon ^{i}$ are the corresponding injection terms. $ST_{R_{ij}}$ and $%
ST_{\varepsilon }$ are also rarely used additional source terms that can
prescribed by the user.

\begin{table}[!htp]
\begin{center}
\begin{tabular}{p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}|p{0,8cm}}
$C_\mu$ & $C_{\varepsilon}$ & $C_{\varepsilon_1}$ & $C_{\varepsilon_2}$ & $%
C_1$ & $C_2$ & $C_3$ & $C_S$ & $C^{\prime}_1$ & $C^{\prime}_2$ \\ \hline
$0,09$ & $0,18$ & $1,44$ & $1,92$ & $1,8$ & $0,6$ & $0,55$ & $0.22$ & $0,5$
& $0,3$ 
\end{tabular}
\end{center}
\caption{Model constants of the \emph{LRR}??? $R_{ij}-\varepsilon$ model \cite{Launder:????}.}
\end{table}

%-------------------------------------------------------------------------------
\subsection{Definition of turbulent eddy viscosity for \emph{LES}}

\begin{description}
 \item[Smagorinsky model] 
\begin{equation}
\mu_{t}=\rho \, \left( C_{s}\,\overline{\Delta } \right)^{2}
\sqrt{2\overline{\tens{S}} \,: \, \overline{\tens{S}}},
\end{equation}%
\nomenclature[odotproductdouble]{$:$}{double dot product}
%
where $\overline{\tens{S}}$ the filtered strain rate tensor components:

\begin{equation}
\overline{\tens{S}}= \symmetric{\overline{\tens{S}}} =
\frac{1}{2} \left[ \gradt \vect{\overline{u}} + \transpose{\left( \gradt \vect{\overline{u}} \right)}
\right].
\end{equation}%
\nomenclature[osymmetric]{$\symmetric{ \left(\tens{.}\right)}$}{symmetric part of a tensor}
%
Here, $\overline{u_{i}}$ stands for the $i^{th}$ resolved velocity component%
\footnote{%
In the case of implicit filtering, the discretisation in space introduces a
spectral low pass filter: only the structures larger that twice the size of
the cells are accounted for. Those structures are called ''the resolved
scales'', whereas the rest, $u_{i}-\overline{u_{i}}$, is referred to as
''unresolved scales'' or ''sub-grid scales''. The influence of the
unresolved scales on the resolved scales have to be modelled.}. 

$C$ is the Smagorinsky constant. Its theoretical value is $0.18$ for
homogenous isotropic turbulence, but the value $0.065$ is classic for
channel flow. 

$\overline{\Delta }$ is the filter width associated with the finite volume
formulation (implicit filtering which corresponds to the integration over a
cell). The value recommended for hexahedral cells is: $\overline{\Delta }%
=2\,|\Omega |^{\frac{1}{3}}$where $|\Omega |$ is the volume of the cell.

\item[Classic dynamic model]
A second filter is introduced: it is an explicit filter with a
characteristic width $\widetilde{\Delta }$ superior to that of the implicit
filter ($\overline{\Delta }$). If $a$ is a discrete variable defined over
the computational domain, the variable obtained after applying the explicit
filter to $a$ is noted $\tilde{a}$. Moreover, with:

\begin{equation}
\begin{array}{ r c l}
\tens{L} & = &\widetilde{\overline{\vect{u}} \otimes \overline{\vect{u}}}
-\widetilde{\overline{\vect{u}}} \otimes \widetilde{\overline{ \vect{u}}}, \\
\tens{\tau} & = & \overline{ \vect{u} \otimes \vect{u}}-\overline{\vect{u}} \otimes \overline{ \vect{u}}, \\
\tens{T} &= &\widetilde{\overline{ \vect{u} \otimes \vect{u}}}-\widetilde{\overline{\vect{u}}} \otimes
\widetilde{\overline{ \vect{u}}},
\end{array}
\end{equation}
Germano identity reads:
\begin{equation}
\tens{L} = \tens{T}-\widetilde{\tens{\tau}}.
\end{equation}

Both dynamic models described herafter rely on the estimation of the tensors
$\tens{T}$ and $\tens{\tau}$ as functions of the filter widths and of the
strain rate tensor (Smagorinsky model). The following modelling is adopted%
\footnote{$\delta_{ij}$ stands for the Kroeneker symbol.}:

\begin{equation}
\begin{array}{ r c l}
T_{ij}-\frac{1}{3}\trace \tens{T} \delta_{ij} &=& -2 C \widetilde{\Delta}^2 |\widetilde{%
\overline{D_{ij}}}| \widetilde{\overline{D_{ij}}}, \\
\tau_{ij}-\frac{1}{3} \tens{\tau } \delta_{ij} &=& -2 C^* \overline{\Delta}^2 |%
\overline{D_{ij}}| \overline{D_{ij}} ,
\end{array}
\end{equation}
where 
$\overline{u}$ stands for the ``implicit-filtered" value of a variable $u$
defined at the centres of the cells and $\overline{u}$ represents the
``explicit-filtered" value associated with the variable $u$. It follows that
the numerical computation of $L_{ij}$ is possible, since it requires the
explicit filtering to be applied to implicitly filtered variables only 
(\textit{i.e.} to the variables explicitly computed).

On the following assumption:

\begin{equation}
C = C^*,
\end{equation}
and assuming that $C^*$ is only slightly non-uniform, so that it can be
taken out of the explicit filtering operator, the following equation is
obtained:

\begin{equation}
\deviator{\tens{L}} =  C \left(
\tens{ \alpha}- \tens{\widetilde{\beta}} \right),
\end{equation}
with:
\begin{equation}
\begin{array}{rcl}
\alpha_{ij} &=& -2 \widetilde{\Delta}^2 |\widetilde{\overline{D_{ij}}}|
\widetilde{\overline{D_{ij}}} , \\
\beta_{ij} &=& -2 \overline{\Delta}^2 |\overline{D_{ij}}| \overline{D_{ij}}.
\end{array}
\end{equation}

Since we are left with six equations to determine one single variable, the
least square method is used\footnote{$L_{kk}$ has no effect for
incompressible flows.}. With:
\begin{equation}
\tens{E} = \tens{L}-C \left( \tens{\alpha} - \tens{\widetilde{\beta}} \right),
\end{equation}
the value for $C$ is obtained by solving the following equation:
\begin{equation}
\frac{\partial \tens{E} : \tens{E}}{\partial C} = 0.
\end{equation}

Finally:
\begin{equation}
C = \frac{ \tens{M} : \tens{L} }{ \tens{M} : \tens{M}},
\end{equation}
with
\begin{equation}
\tens{M} = \tens{\alpha} - \tens{\widetilde{\beta}}.
\end{equation}

This method allows to calculate the Smagorinsky "constant" dynamically at
each time step and at each cell. However, the value obtained for $C$ can be
subjected to strong variations. Hence, this approach is often restricted to
flows presenting one or more homogeneous directions (Homogeneous Isotropic
Turbulence, 2D flows presenting an homogeneous spanwise direction...):
indeed, in such cases, the model can be (and is) stabilized by replacing $C$
by an average value of $C$ computed over the homogeneous direction(s).

For a general case (without any homogeneous direction), a specific averaging
is introduced to stabilize the model: for any given cell of the mesh, the
averaged Smagorinsky constant is obtained as an average of $C$ over the
"extended neighbourhood" of the cell (the set of cells that share at least
one vertex with the cell considered). More precisely, the average value
(also denoted $C$ hereafter) is calculated as indicated below:

\begin{equation}
C = \frac{\widetilde{ \tens{M} : \tens{L}}} {\widetilde{ \tens{M} : \tens{M}}}
\end{equation}

\end{description}

%-------------------------------------------------------------------------------
\section{Thermal equations}

%-------------------------------------------------------------------------------
\subsection{Energy equation}
The energy equation reads:
\begin{equation}
 \rho \DP{e} = -\divs \underline{q''}+q'''-P\divs \underline{u} + \mu s^2 
\label{eq:energy}
\end{equation}
where 
\begin{itemize}
       \item $e$ is the specific internal energy
       \item $\underline{u}$ is the velocity vector
       \item $\underline{q''}$ is the heat flux vector, the Fourier law of heat conduction gives: $\displaystyle \underline{q''}=-\lambda \grad T$
       \item $q'''$ is the dissipation rate or rate of internal heat generation
       \item $S^2$ is scalar strain rate defined by CHECKME
	  \begin{equation}
	    \begin{array}{rcl}
	      S^2 & = & 2 \tens{S} : \tens{S}
	    \end{array}
	  \end{equation}
      \end{itemize}

%-------------------------------------------------------------------------------
\subsection{Enthalpy equation}

Thermodynamics definition of enthalpy gives:
\begin{equation}
 h=e+ \dfrac{1}{\rho} P
\end{equation}

Applying the lagrangian derivative $\DP{}$ to $h$:
\begin{equation}
 \DP{h}=\DP{e}+\frac{1}{\rho}\DP{P}-\frac{P}{\rho^2}\DP{\rho}
\end{equation}
%
then
\begin{align}
  \rho \DP{h} &= \divs \left( \lambda \grad T \right) +q'''-P\divs \vect{u} + \mu S^2 + \DP{P} -\frac{P}{\rho}\DP{\rho} \\
  \rho \DP{h} &= \divs \left( \lambda \grad T \right) +q''' + \mu  S^2 + \DP{P} - \frac{P}{\rho} \left(\underbrace{\DP{\rho} + \rho \divs \underline{u}}_{\displaystyle =0} \right) \\
  \rho \DP{h} &= \divs \left( \lambda \grad T \right) +q''' + \mu  S^2 + \DP{P} 
\label{eq:enthalpyT}
\end{align}

To have only enthalpy in equation, one can use:
\begin{itemize}
 \item for ideal gas: $\displaystyle \dd h=C_p \dd T$,
 \item for incompressible liquid: $\displaystyle \dd h=C_p \dd T + \dfrac{1}{\rho} \dd P$.
\end{itemize}

If the incompressible liquid hypothesis is used, the equation \ref{eq:enthalpyT} becomes:
\begin{equation}
 \rho \DP{h} = \divs \left( \dfrac{\lambda}{C_p} \left(\grad h -\frac{\grad P}{\rho}\right)\right) +q''' + \mu S^2 + \DP{P} 
\label{eq:enthalpyH}
\end{equation}

%-------------------------------------------------------------------------------
\subsection{Temperature equation}

In order to rearrange the enthalpy Equation (\ref{eq:enthalpyT}) in terms of temperature, one can use:
\begin{equation}
 \dd h = T \dd s + \frac{1}{\rho} \dd P
\end{equation}

The entropy $s$ can be written as:
\begin{equation}
 \dd s = \left.\der{s}{T}\right|_P \dd T + \left.\der{s}{P}\right|_T \dd P
\label{eq:Ds}
\end{equation}

Using Maxwell's relations, for a pure substance we can obtain:
\begin{equation}
 \dd s = \frac{C_p}{T} \dd T - \left.\der{(1/\rho}{T}\right|_P  \dd P
\label{eq:Ds_maxwell}
\end{equation}

In the r.h.s. of Equation (\ref{eq:Ds}), the second term becomes:
\begin{equation}
 \left.\der{s}{P}\right|_T = -  \left.\der{(1/\rho)}{T}\right|_P = \frac{1}{\rho^2} \left.\der{\rho}{T}\right|_P=-\frac{\beta}{\rho}
\end{equation}
where $\beta$ is the thermal expansion coefficient is defined by:
\begin{equation}
 \beta= -\frac{1}{\rho}  \left.\der{\rho}{T}\right|_P
\end{equation}

the Maxwell's relations give also:
\begin{equation}
 \left.\der{s}{T}\right|_P= \frac{C_p}{T}
\end{equation}

Combining all this equations, we obtain:
\begin{equation}
  \dd h=C_p \dd T + \frac{1}{\rho} \left( 1-\beta T \right)\dd P
\end{equation}

So the l.h.s. of Equation (\ref{eq:enthalpyT}) becomes:
\begin{equation}
 \rho \DP{h} = \rho C_p \DP{T} + \left( 1-\beta T \right)\DP{P}
\end{equation}
%
 then,
\begin{equation}
  \rho C_p \DP{T}=  \divs \left( \lambda \grad T \right) + \beta T \DP{P} +q''' + \mu S^2
\label{eq:T_all}
\end{equation}

The Eq. (\ref{eq:T_all}) can be reduce using some hypothesis, for example:
\begin{itemize}
 \item If the fluid is an ideal gas, $\beta=\dfrac{1}{T}$ and it becomes:
\begin{equation}
  \rho C_p \DP{T}=  \divs \left( \lambda \grad T \right) + \DP{P} +q''' + \mu S^2
\end{equation}

 \item If the fluid is incompressible, $\beta=0$ and it becomes:
\begin{equation}
  \rho C_p \DP{T}=  \divs \left( \lambda \grad T \right) +q''' + \mu S^2
\end{equation}

 \item If the fluid is incompressible, $q'''=0$ and $\mu \phi=0$,  it becomes:
\begin{equation}
  \rho C_p \DP{T}=  \divs \left( \lambda \grad T \right)
\end{equation}
\end{itemize}


%-------------------------------------------------------------------------------
\section{Equations for scalars}

Two types of transport equations are considered: 
%
\begin{enumerate}[ label=\roman{*}/, ref=(\roman{*})]
\item advection of a scalar with additional source terms:
\begin{equation}
\frac{\partial (\rho a)}{\partial t} +
\underbrace{
\dive \left( a \, \rho \underline{u})
\right)
}_{\text{advection}}
-\underbrace{
\dive \left( K\grad a \right) 
}_{
\text{diffusion}} = ST_{a}+\Gamma \,a^{i},
\end{equation}%

\item advection of the variance $\widetilde{{a"}^{2}}$ with
additional source terms:
\begin{equation}
\begin{array}{rcl}
\displaystyle\frac{\partial \left(\rho \widetilde{{a"}^{2}}\right)}{\partial t}+%
\underbrace{
\dive \left( \widetilde{{a"}^{2}} \, \rho \,\underline{u} \right)
}_{\text{advection}}
-\underbrace{
\dive \left( K\ \grad\widetilde{{a"}^{2}} \right)
}_{\text{diffusion}}
&=&ST_{\widetilde{{a"}^{2}}}+ \ \Gamma \, \widetilde{{a"}^{2}}^{i} 
\\
& &\displaystyle +
\underbrace{
2\,\frac{\mu _{t}}{\sigma _{t}} \left( \grad\widetilde{a} \right)^{2}-
\frac{\rho \,\varepsilon }{R_{f}k}\ \widetilde{{a"}^{2}}
}_{\text{production and dissipation}} ,
\end{array}%
\end{equation}%
\end{enumerate}


The two previous equations can be unified formally as:
\begin{equation}\label{eq:base_introd_depart}%Base_Introd_depart}
\frac{\partial (\rho f)}{\partial t}+\dive\,((\rho \,\underline{u})f)-\dive%
\,(K\grad f)=ST_{f}+\Gamma \,f^{i}+T_{s}^{\,pd}  
\end{equation}%
with:
\begin{equation}
\displaystyle T_{s}^{\,pd} = 
\left\{
\begin{array}{ll}
 0 & \text{ for $f=a$ }, \\
 2 \displaystyle \frac{\mu_t}{\sigma_t}(\grad \widetilde{a})^2 - \displaystyle
\frac{\rho\,\varepsilon}{R_f k}\ \widetilde{{a"}^2} & \text{for
$f=\widetilde{{a"}^2}$. }
\end{array}%
\right.
\end{equation}

$ST_f$ represents the additional source terms that may be prescribed by the
user.

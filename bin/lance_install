#!/bin/sh
#============================================================================
#
#                    Code_Saturne version 1.3
#                    ------------------------
#
#
#     This file is part of the Code_Saturne Kernel, element of the
#     Code_Saturne CFD tool.
#
#     Copyright (C) 1998-2008 EDF S.A., France
#
#     contact: saturne-support@edf.fr
#
#     The Code_Saturne Kernel is free software; you can redistribute it
#     and/or modify it under the terms of the GNU General Public License
#     as published by the Free Software Foundation; either version 2 of
#     the License, or (at your option) any later version.
#
#     The Code_Saturne Kernel is distributed in the hope that it will be
#     useful, but WITHOUT ANY WARRANTY; without even the implied warranty
#     of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with the Code_Saturne Kernel; if not, write to the
#     Free Software Foundation, Inc.,
#     51 Franklin St, Fifth Floor,
#     Boston, MA  02110-1301  USA
#
#=========================================================================
#     Script to generate Code_Saturne Kernel libraries
#=========================================================================
#
#
# Function: exit
# ==============
#
 local_exit()
 {
   tput rmso ; tput sgr0
   tput init 
   exit
 }
#
# Function: help
# ==============
#
 usage() {
    echo
    echo "   Script to generate Code_Saturne Kernel libraries                "
    echo
    echo "   Syntax: ./lance_install                                         "
    echo "       or: ./lance_install <Lib>                                   "
    echo "       or: ./lance_install -<OPT>                                  "
    echo 
    echo "      with:                                                        "
    echo "      <Lib>: list of libraries (space between them)                " 
    echo "            either: <MOD> or <MOD>/<OPT>                           " 
    echo "                or:                                                "
    echo "                <MOD> means $listemodall                           " 
    echo "                <OPT> means $listeoptall                           " 
    echo 
    echo "      The default list of libraries (listelib) is                  "
    echo "          $listemoddef                                             "
    echo 
    echo " Examples of syntax:                                               "
    echo "   ./lance_install                                                 "
    echo "   ./lance_install BASE LAGR BASE/DBG                              "
    echo "   ./lance_install -PUR                                            "
    echo
    echo
    echo " Exceptions:                                                       "
    echo "   ./lance_install DOC                                             "
    echo "          compilation of the documentation (userguide, theory      "
    echo "                                                     and tutorial) "
    echo "   ./lance_install -nc                                             "
    echo "          does not remove the objects of the build directory       "
    echo
    local_exit
 }
#
# Function: Error message with output
# ===================================
#
 sortie()
 {
   dir_sortie=`pwd`
   echo '  ' Directory: ${dir_sortie}
   echo 
   tput bold
   echo '  ' Error : $*
   tput rmso ; tput sgr0
   tput init
   echo 
   local_exit
 }
#
#
# Function: banner message
# ========================
#
 banner()
 {
   tput bold
   echo 
   echo '   ' $1
   shift
   echo '   ' $1
   shift
   if [ "$*" != "" ] ; then 
     echo '   ' $*
   fi
   echo '       ==================================================================  '
   tput rmso ; tput sgr0
   tput init
 }
#
#
# Function: final banner message
# ==============================
#
 bannerfin()
 {
   tput bold
   echo '   ' $1
   shift
   echo '   ' $1
   shift
   if [ "$*" != "" ] ; then 
     echo '   ' $*
   fi
   echo
   tput rmso ; tput sgr0
   tput init
 }
#
#
# Function: Generation of the title
# =================================
#
 titre()
 {
   tput smso
   echo 
   echo ' ***' $*
   tput rmso ; tput sgr0
   tput init
 }
#
#
# Function: Message of titrefin
# =============================
#
 titrefin()
 {
   tput smso
   echo ' ***' $*
   tput rmso ; tput sgr0
   tput init
 }
#
#
# Function: Infos
# ===============
#
 info()
 {
   echo '  ' $*
 }
#
#
# Function: Infos concerning the compilation
# ==========================================
#
# Generate the infos about the compiler, the userid, the date ... 
#   Give the file name to be created in argument
#   Give the macro file name containing the options
#
cree_readme_comp()
{
Fic_readme_comp=$1
Macro_readme_comp=$2
#
  echo                                                             \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo                                                             \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo '=========================================================='\
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo '------------------------------------------------'          \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo ' Who, where and when: '                                     \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  whoami     >> $Fic_readme_comp || exit create $Fic_readme_comp
  pwd        >> $Fic_readme_comp || exit create $Fic_readme_comp
  date       >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo '------------------------------------------------'          \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo ' Machine Name: '                                            \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  uname -a                                                         \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo '------------------------------------------------'          \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo ' Compilers: '                                          \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
# subdirectory to fool the Makefile, so that it does not build up a library. 
  wrk=wrk_compiler_version
  mkdir $wrk 
  cd $wrk 
  ${CS_HOME}/bin/compiler_version -cshome ${CS_HOME}               \
                                  -nomarch ${NOM_ARCH}             \
        -output $Fic_readme_comp || exit create $Fic_readme_comp
  cd .. 
  rm -rf $wrk
  echo '------------------------------------------------'          \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo ' Options: '                                               \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  cat ${Macro_readme_comp}                                         \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo '------------------------------------------------'          \
             >> $Fic_readme_comp || exit create $Fic_readme_comp

  echo '=========================================================='\
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo                                                             \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
  echo                                                             \
             >> $Fic_readme_comp || exit create $Fic_readme_comp
}
#
#
#=========================================================================
#                        Initial Checks
#=========================================================================
#
# Default: List of the libraries to generate
# ==========================================
#
# List of all the modules (Special treatment for DOC)
 listemodall="BASE CFBL COGZ CPLV ELEC FUEL LAGR MATI RAYT"
 listemoddef="BASE CFBL COGZ CPLV ELEC FUEL LAGR MATI RAYT"
#
# List of all the options
 listeoptall="LO DBG EM EF PROF PUR"
#
#
# Help
# ====
#
 case $1 in 
   -help|-h) usage ; local_exit
 esac
#
#
# Generation of DOC
# =================
#
 if [ "$1" = "DOC" ] ; then
  titre "Compilation of the theory"
  cd ../doc/THEORY
  make
  make clean
  titrefin "End of the theory compilation"
  echo
  titre "Compilation of the userguide"
  cd ../USER
  make
  make clean
  titrefin "End of the userguide compilation"
  echo
  titre "Compilation of the tutorials"
  cd ../TUTORIAL
  make
  make clean
  titrefin "End of the tutorials compilation"
  local_exit
 fi
#
#
# Generation of the locale files
# ==============================
#
 if [ "$1" = "PO" ] ; then
   titre "Creation of locale files"
   mkdir -p ${CS_HOME}/arch/${NOM_ARCH}/share/locale/fr/LC_MESSAGES
   cp -f ${CS_HOME}/po/fr.gmo ${CS_HOME}/arch/${NOM_ARCH}/share/locale/fr/LC_MESSAGES/ncs.mo
   titrefin "End of creation of locale files"
   local_exit
 fi
#
#
# List of the libraries to generate
# =================================
#
 listeopt=""
 if [ "$*" != "" ] ; then 
   listeopt="$*"
 fi
#
# use of -noclean
 clean="yes"
 listeopt1=""
 for opt in $listeopt ; do
   if [ "$opt" != "-nc" ] ; then 
     if [ -z "${listeopt1}" ] ; then 
       listeopt1="$opt"
     else
       listeopt1="${listeopt1} $opt"
     fi
   else
     clean="no"
   fi 
 done 
 listeopt="${listeopt1}"
#
# determination of mod and opt 
 listelib=""    
 if [ -z "${listeopt}" ] ; then
   for mod in $listemoddef ; do 
     listelib="$listelib $mod"
   done
   listelib="$listelib LINK"
 else
   for opt in $listeoptall ; do
     if [ "$listeopt" = "-$opt" ] ; then
       for mod in $listemoddef ; do 
         listelib="$listelib $mod/$opt"
       done
       listelib="$listelib LINK/$opt"
     fi
   done 
 fi
 if [ -z "${listelib}" ] ; then
   listelib="${listeopt}"
 fi
#
# Check
# =====
#
 for var in $listelib ; do 
#
# library modverif/optverif
   optverif=`basename "$var"`
   modverif=`dirname  "$var"`
   if   [ "$modverif" = "." ] ; then 
     modverif=$optverif
     optverif=""
   fi
#
# Is modverif known?
   okmod="no"
   for mod in $listemodall ; do 
     if [ "$modverif" = "$mod" ] ; then 
       okmod="yes"
     fi
   done
   if [ "$modverif" = "LINK" ] ; then 
     okmod="yes"
   fi
#
# Is optverif known?
   if [ "$optverif" != "" ] ; then 
     okopt="no"
     for opt in $listeoptall ; do 
       if [ "$optverif" = "$opt" ] ; then 
         okopt="yes"
       fi
     done 
   fi
#
   if [ "$okmod" = "no" ] ; then
     sortie "MOD=$modverif is not known"
   fi
   if [ "$okopt" = "no" ] ; then
     sortie "OPT=$optverif is not known"
   fi
#
 done
#
#
# Is the architecture supported?
 if [ ! -f ${CS_HOME}/bin/macros_${NOM_ARCH}.mk ]
 then
  sortie "Architecture ${NOM_ARCH} not supported by this version of Code_Saturne"
 fi
#
 banner "Installation of the following libraries $listelib under $NOM_ARCH"\
        " Version of Code_Saturne ${CS_HOME} "
#
# The starting directory has to be $CS_HOME/bin (ex: /home/saturne/ncs-vrp/bin)
# =============================================================================
#
 repbase=${CS_HOME}
 reptrav=`pwd`
 repprec=`dirname $reptrav`
 if [ $repbase != $repprec ] ; then 
   if [ $repbase = "" ] ; then 
     sortie "The variable CS_HOME has to be properly initialised"
   else
     sortie "The installation has to be launched from CS_HOME/bin = ${CS_HOME}/bin"
   fi
 fi
 if [ ! -d ${CS_HOME} ] ; then 
   sortie "${CS_HOME} does not exist"
 fi 
#
 titre "The initial directory is CS_HOME = ${CS_HOME}"
#
# Protection prealable
# ====================
#
  titre "Prerequisite protection"
#
  umask 007            || sortie "It is not possible to set up umask"
#
#
#=========================================================================
#                        Installation 
#=========================================================================
#
#
# General directory
# =================
#
 cd ${CS_HOME}  || sortie  "The ${CS_HOME} directory can not be reached"
#
 build=build
 if [ ! -d $build ] ; then 
   mkdir $build
 fi
 if [ ! -d $build/${NOM_ARCH} ] ; then 
   mkdir $build/${NOM_ARCH}
 fi
#
# Chmod of the library directories
#
  if [ -d ${CS_HOME}/arch/${NOM_ARCH}/lib ] ; then
    chmod g-rwx,o-rwx ${CS_HOME}/arch/${NOM_ARCH}/lib
  fi
#
#
# General loop
# ============
#
 for dirlib in $listelib ; do 
#
   titre "Construction of $dirlib under ${NOM_ARCH}"
#
   cd ${CS_HOME}/$build/${NOM_ARCH} || sortie  "The ${CS_HOME}/$build/${NOM_ARCH} directory can not be reached"
#
# Directory of the library
# ========================
#
   info "Generation of the $dirlib directory"
#
   modtrav=`echo $dirlib |cut -f1 -d"/"`
   if [ $modtrav = $dirlib ] ; then 
     opttrav=""
   else
     opttrav=`echo $dirlib |cut -f2 -d"/"`
   fi
#
   if [ ! -d $modtrav ] ; then 
     mkdir $modtrav
   fi
   if [ ! -d $modtrav/$opttrav ] ; then 
     mkdir $modtrav/$opttrav
   fi
#
   cd $dirlib || sortie  "The $dirlib directory can not be reached" 
#
#
   info "Link to the Makefile"
#
   if [ ! -f Makefile ] ; then 
     ln -s ${CS_HOME}/bin/Makefile . || sortie  "The Makefile already exists or ${CS_HOME}/bin/Makefile can not be reached"
   else 
     info "Makefile already exists, and links on "
     ls -al ${CS_HOME}/bin/Makefile | awk '{print $NF}'
   fi
# 
   info "Start of make with MOD=$modtrav OPT=$opttrav"
#
   if [ "${modtrav}" != "LINK" ] ; then
     if   [ "${opttrav}" = "" ] ; then 
       make lib_install MOD="$modtrav"                || sortie "make lib_install MOD=$modtrav failed"
     else
       make lib_install MOD="$modtrav" OPT="$opttrav" || sortie "make lib_install MOD=$modtrav OPT=$opttrav failed"
     fi
   else
     if   [ "${opttrav}" = "" ] ; then 
       make saturne                || sortie "make saturne failed"
     else
       make saturne OPT="$opttrav" || sortie "make saturne OPT=$opttrav failed"
     fi
     for file in *.exe ; do
       mv $file ${CS_HOME}/arch/${NOM_ARCH}/bin/`basename $file .exe`${opttrav}.exe
     done
   fi
#
   info "Generation of the summary file" 
#
   readme=.readme${modtrav}${opttrav}
   cree_readme_comp `pwd`/$readme ${CS_HOME}/bin/macros_${NOM_ARCH}.mk 
   cat $readme >> ${CS_HOME}/arch/${NOM_ARCH}/lib/$readme   || sortie  "writing of the summary file failed"
#
   info "Cleaning with MOD=$modtrav OPT=$opttrav"
#
   if [ "${clean}"   = "yes" ] ; then 
     if [ "${opttrav}" = "" ] ; then 
       make clean MOD="$modtrav"              || sortie "make clean MOD=$modtrav failed"
     else
       make clean MOD="$modtrav" OPT="$opttrav" || sortie "make clean MOD=$modtrav OPT=$opttrav failed"
     fi
   fi
   \rm -f $readme
#
#
#
# End of the general loop
# =======================
#
     titrefin "End of the construction of $dirlib"
#
#
 done
#
#
# Check of the permissions
# ========================
#
 titre "Permission checks"
#
 cd ${CS_HOME} || sortie  "The ${CS_HOME} directory can not be reached"
#
# Full permissions for reading
 find . -type d -exec chmod    u=rwx,g=rx,o=rx {} \;
 find . -type f -exec chmod    u=rw,g=r,o=r {} \;
# Executables for the saturne login
 listebin="autovalid \
check_mesh \
compiler_version \
cree_sat \
cs.exe \
gracehst \
grp \
info_cs \
lance_install \
rang_mpi.sh"
 for fich in $listebin  ; do 
   chmod    u+x bin/$fich
 done
# Files readable and executable by all
 listebin="autovalid \
compiler_version \
check_mesh \
cree_sat \
cs.exe \
gracehst \
grp \
info_cs \
rang_mpi.sh"
 for fich in $listebin  ; do 
   chmod   g+x,o+x bin/$fich
 done
# Executable files in aux
 listeaux="rmb.sh \
rmb.sh_lance"
 for fich in $listeaux  ; do 
   chmod    u+x aux/$fich
 done
# Executable files in sbin
 listesbin="backup gettextize"
 for fich in $listesbin  ; do 
   chmod    u+x sbin/$fich
 done
# Executable files in arch
find arch -name "*.exe" -exec chmod uog+x {} \;
# Access to the lib directory
  chmod g+rx,o+rx ${CS_HOME}/arch/${NOM_ARCH}/lib
#
 titrefin "End of the permission checks"

 bannerfin "End of the installation of the $listelib libraries" \
           " Code_Saturne version ${CS_HOME} "

